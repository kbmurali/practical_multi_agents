configs:
  clickhouse_config:
    file: ../observability/clickhouse/clickhouse_config.xml

services:
  # Neo4j Knowledge Graph
  neo4j-kg:
    image: neo4j:5.15-community
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    secrets:
      - NEO4J_KG_PASSWORD
    # Neo4j doesn't support *_FILE for NEO4J_AUTH, so we build it at runtime from the Swarm secret.
    entrypoint:
      - /bin/bash
      - -lc
      - |
        export PATH="/var/lib/neo4j/bin:$$PATH";
        export NEO4J_AUTH="neo4j/$$(cat /run/secrets/NEO4J_KG_PASSWORD)";
        exec /startup/docker-entrypoint.sh neo4j
    command: ["neo4j"]
    environment:
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512M
    volumes:
      - neo4j-kg-data:/data
      - neo4j-kg-logs:/logs
    networks:
      - health-insurance-network
    healthcheck:
      test: ["CMD-SHELL", 'cypher-shell -u neo4j -p "$$(cat /run/secrets/NEO4J_KG_PASSWORD)" "RETURN 1"']
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j Context Graph
  neo4j-cg:
    image: neo4j:5.15-community
    ports:
      - "7475:7474"  # HTTP (different port than KG)
      - "7688:7687"  # Bolt (different port than KG)
    secrets:
      - NEO4J_CG_PASSWORD
    entrypoint:
      - /bin/bash
      - -lc
      - |
        export PATH="/var/lib/neo4j/bin:$$PATH";
        export NEO4J_AUTH="neo4j/$$(cat /run/secrets/NEO4J_CG_PASSWORD)";
        exec /startup/docker-entrypoint.sh neo4j
    command: ["neo4j"]
    environment:
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512M
    volumes:
      - neo4j-cg-data:/data
      - neo4j-cg-logs:/logs
    networks:
      - health-insurance-network
    healthcheck:
      test: ["CMD-SHELL", 'cypher-shell -u neo4j -p "$$(cat /run/secrets/NEO4J_CG_PASSWORD)" "RETURN 1"']
      interval: 10s
      timeout: 5s
      retries: 5

  # MySQL
  mysql:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - "3306:3306"
    secrets:
      - MYSQL_ROOT_PASSWORD
      - MYSQL_PASSWORD
    environment:
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/MYSQL_ROOT_PASSWORD
      - MYSQL_DATABASE=health_insurance
      - MYSQL_USER=app_user
      - MYSQL_PASSWORD_FILE=/run/secrets/MYSQL_PASSWORD
    volumes:
      - mysql-data:/var/lib/mysql
      - ../databases/mysql_schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - health-insurance-network
    healthcheck:
      test: ["CMD-SHELL", 'mysqladmin ping -h localhost -u root -p"$$(cat /run/secrets/MYSQL_ROOT_PASSWORD)"']
      interval: 10s
      timeout: 5s
      retries: 5

  # Chroma Vector Database
  chroma:
    image: chroma-with-curl:latest
    command: ["run", "--host", "0.0.0.0", "--port", "8000", "--path", "/chroma/chroma"]
    ports:
      - target: 8000
        published: 8000
        protocol: tcp
        mode: host
    environment:
      IS_PERSISTENT: "TRUE"
      ANONYMIZED_TELEMETRY: "FALSE"
    volumes:
      - chroma-data:/chroma/chroma
    networks:
      - health-insurance-network
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/api/v2/heartbeat >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 120s
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
      update_config:
        order: stop-first
        parallelism: 1
        delay: 5s
  # LangFuse (Observability Components)
  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    secrets:
      - CLICKHOUSE_PASSWORD
    environment:
      CLICKHOUSE_DB: langfuse
      CLICKHOUSE_USER: langfuse
      CLICKHOUSE_PASSWORD_FILE: /run/secrets/CLICKHOUSE_PASSWORD
    configs:
      - source: clickhouse_config
        target: /etc/clickhouse-server/config.d/keeper.xml
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    networks:
      - health-insurance-network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8123/ping | grep -q 'Ok'"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s

  langfuse-redis:
    image: redis:7.2-alpine
    networks:
      - health-insurance-network

  langfuse-minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    secrets:
      - MINIO_ROOT_PASSWORD
    environment:
      - MINIO_ROOT_USER=minio
      - MINIO_ROOT_PASSWORD_FILE=/run/secrets/MINIO_ROOT_PASSWORD
    volumes:
      - minio-data:/data
    networks:
      - health-insurance-network

  langfuse-db:
    image: postgres:15
    secrets:
      - LANGFUSE_DB_PASSWORD
    environment:
      - POSTGRES_USER=langfuse
      - POSTGRES_PASSWORD_FILE=/run/secrets/LANGFUSE_DB_PASSWORD
      - POSTGRES_DB=langfuse
    volumes:
      - langfuse-db-data:/var/lib/postgresql/data
    networks:
      - health-insurance-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U langfuse"]
      interval: 10s
      timeout: 5s
      retries: 5

  langfuse:
    image: langfuse/langfuse:latest
    ports:
      - target: 3000
        published: 3001
        protocol: tcp
        mode: host
    secrets:
      - LANGFUSE_DB_PASSWORD
      - LANGFUSE_NEXTAUTH_SECRET
      - LANGFUSE_SALT
      - LANGFUSE_ENCRYPT_KEY
      - CLICKHOUSE_PASSWORD
      - MINIO_ROOT_PASSWORD
    entrypoint:
      - /bin/sh
      - -lc
      - |
        DB_PW="$$(cat /run/secrets/LANGFUSE_DB_PASSWORD)";
        CH_PW="$$(cat /run/secrets/CLICKHOUSE_PASSWORD)";
        MIO_PW="$$(cat /run/secrets/MINIO_ROOT_PASSWORD)";

        # --- Authentication & Database ---
        export CLICKHOUSE_USER="langfuse";
        export CLICKHOUSE_PASSWORD="$${CH_PW}";
        export DATABASE_URL="postgresql://langfuse:$${DB_PW}@langfuse-db:5432/langfuse";
        export CLICKHOUSE_URL="http://langfuse:$${CH_PW}@clickhouse:8123/langfuse";
        export CLICKHOUSE_MIGRATION_URL="clickhouse://langfuse:$${CH_PW}@clickhouse:9000/langfuse";
        export NEXTAUTH_URL="http://localhost:3001";
        export NEXTAUTH_SECRET="$$(cat /run/secrets/LANGFUSE_NEXTAUTH_SECRET)";
        export SALT="$$(cat /run/secrets/LANGFUSE_SALT)";
        export ENCRYPTION_KEY="$$(cat /run/secrets/LANGFUSE_ENCRYPT_KEY)";
        
        # --- REDIS CONFIG (Required) ---
        export REDIS_HOST="langfuse-redis";
        export REDIS_PORT="6379";
        export REDIS_AUTH="";

        # --- NEW: BLOB STORAGE CONFIG (Required) ---
        # We use the MinIO service defined below
        export LANGFUSE_S3_EVENT_UPLOAD_BUCKET="langfuse";
        export LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT="http://langfuse-minio:9000";
        export LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID="minio";
        export LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY="$${MIO_PW}";
        export LANGFUSE_S3_EVENT_UPLOAD_REGION="us-east-1";
        export LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE="true";

        #
        test -n "$${DATABASE_URL}" || (echo "DATABASE_URL not set" && exit 1);
        test -n "$${CLICKHOUSE_URL}" || (echo "CLICKHOUSE_URL not set" && exit 1);
        test -n "$${CLICKHOUSE_MIGRATION_URL}" || (echo "CLICKHOUSE_MIGRATION_URL not set" && exit 1);
        # --- ADDED: WAIT FOR POSTGRES ---
        echo "Waiting for Postgres (langfuse-db:5432)..."
        # Loop until netcat (nc) successfully connects to the DB host and port
        until nc -z langfuse-db 5432; do
          echo "Postgres is unavailable - sleeping"
          sleep 2
        done
        echo "Postgres is up!"
        # --------------------------------
        exec ./web/entrypoint.sh node web/server.js
    depends_on:
      - langfuse-db
      - clickhouse
      - langfuse-redis
      - langfuse-minio
    networks:
      - health-insurance-network
    deploy:
      restart_policy:
        condition: on-failure
     # Optional: keep only if the image has curl; otherwise remove or swap to wget.
    healthcheck:
      test: ["CMD-SHELL", "/usr/bin/wget -q -O /dev/null http://127.0.0.1:3000/api/public/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 60s

  # Prometheus (Metrics)
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ../observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - health-insurance-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Grafana (Dashboards)
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3002:3000"
    secrets:
      - GRAFANA_ADMIN_PASSWORD
    environment:
      # Grafana supports reading secrets from files via *__FILE (double underscore).
      - GF_SECURITY_ADMIN_PASSWORD__FILE=/run/secrets/GRAFANA_ADMIN_PASSWORD
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ../observability/grafana/datasources:/etc/grafana/provisioning/datasources
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - health-insurance-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  neo4j-kg-data:
  neo4j-kg-logs:
  neo4j-cg-data:
  neo4j-cg-logs:
  mysql-data:
  chroma-data:
  clickhouse-data:
  minio-data:
  langfuse-db-data:
  prometheus-data:
  grafana-data:

networks:
  health-insurance-network:
    driver: overlay

# ============================================
# Secrets (Docker Swarm external secrets)
# ============================================
secrets:
  NEO4J_KG_PASSWORD:
    external: true
  NEO4J_CG_PASSWORD:
    external: true
  MYSQL_ROOT_PASSWORD:
    external: true
  MYSQL_PASSWORD:
    external: true
  CLICKHOUSE_PASSWORD:
    external: true
  MINIO_ROOT_PASSWORD:
    external: true
  LANGFUSE_DB_PASSWORD:
    external: true
  LANGFUSE_NEXTAUTH_SECRET:
    external: true
  LANGFUSE_SALT:
    external: true
  LANGFUSE_ENCRYPT_KEY:
    external: true
  GRAFANA_ADMIN_PASSWORD:
    external: true
  SECRET_KEY:
    external: true
  OPENAI_API_KEY:
    external: true
  ANTHROPIC_API_KEY:
    external: true
